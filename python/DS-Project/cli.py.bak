# cli.py
import argparse, time
from io_utils import (
    load_image_grayscale,
    save_png_from_array,
    file_size,
    read_spco_binary,
)
from sparse_formats import COO
from alg.rle import rle_encode_rowmajor, rle_decode_rowmajor
import numpy as np


def compress(args):
    arr = load_image_grayscale(args.input, threshold=args.threshold)
    fmt = args.format.lower()
    start = time.perf_counter()
    coo = COO.from_dense(arr)
    if fmt == "coo":
        coo.to_json(args.output)
    elif fmt == "bin":
        coo.to_binary(args.output)
    elif fmt == "rle":
        rle = rle_encode_rowmajor(arr)
        import json

        with open(args.output, "w") as f:
            json.dump({"format": "RLE", "shape": list(arr.shape), "data": rle}, f)
    else:
        raise SystemExit("unknown format")
    elapsed = time.perf_counter() - start
    print(
        f"Compressed ({fmt}) in {elapsed:.3f}s  nonzeros={len(coo.data)}  orig={file_size(args.input)}B comp={file_size(args.output)}B"
    )


def decompress(args):
    # detect format
    if args.input.endswith(".coo.json") or args.input.endswith(".json"):
        coo = COO.from_json(args.input)
        arr = coo.to_dense(dtype=np.uint8)
        save_png_from_array(arr, args.output)
    else:
        # try binary
        try:
            shape, data = read_spco_binary(args.input)
            coo = COO(shape, data)
            arr = coo.to_dense(dtype=np.uint8)
            save_png_from_array(arr, args.output)
        except Exception as e:
            print("Failed binary read:", e)
            import json

            with open(args.input, "r") as f:
                o = json.load(f)
            if o["format"] == "RLE":
                arr = np.array(
                    sum([[v] * cnt for v, cnt in o["data"]], []), dtype="uint8"
                ).reshape(o["shape"])
                save_png_from_array(arr, args.output)
            else:
                raise


def visualize(args):
    coo = COO.from_json(args.input)
    arr = coo.to_dense(dtype=np.uint8)
    import matplotlib.pyplot as plt

    mask = (arr > 0).astype("uint8")
    plt.imshow(mask, cmap="gray")
    plt.axis("off")
    plt.savefig(args.output)
    print("Saved", args.output)


def bench(args):
    # simple bench: compress sizes for different thresholds
    import os, json
    from io_utils import file_size

    thresholds = args.thresholds
    results = []
    for t in thresholds:
        arr = load_image_grayscale(args.input, threshold=t)
        coo = COO.from_dense(arr)
        import tempfile

        p = tempfile.NamedTemporaryFile(delete=False).name + ".json"
        coo.to_json(p)
        results.append((t, arr.size, len(coo.data), os.path.getsize(p)))
        os.remove(p)
    print("threshold, total_pixels, nonzeros, comp_bytes")
    for r in results:
        print(r)
    # optionally plot


def main():
    p = argparse.ArgumentParser()
    sub = p.add_subparsers(dest="cmd")

    c = sub.add_parser("compress")
    c.add_argument("--input", required=True)
    c.add_argument("--output", required=True)
    c.add_argument("--format", default="coo", choices=["coo", "bin", "rle"])
    c.add_argument("--threshold", type=int, default=None)

    d = sub.add_parser("decompress")
    d.add_argument("--input", required=True)
    d.add_argument("--output", required=True)

    v = sub.add_parser("visualize")
    v.add_argument("--input", required=True)
    v.add_argument("--output", required=True)

    b = sub.add_parser("bench")
    b.add_argument("--input", required=True)
    b.add_argument(
        "--thresholds", nargs="+", type=int, default=[None, 10, 30, 60, 100, 150, 200]
    )

    a = p.parse_args()
    if a.cmd == "compress":
        compress(a)
    elif a.cmd == "decompress":
        decompress(a)
    elif a.cmd == "visualize":
        visualize(a)
    elif a.cmd == "bench":
        bench(a)
    else:
        p.print_help()


if __name__ == "__main__":
    main()
